<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" href="style.css" />
	<script src="js/main.min.js" type="text/javascript"></script>
	<script src="js/jquery-3.2.1.min.js" type="text/javascript"></script>
</head>

<body>
	<section class="main">
		<div class="header"></div>
		<div class="creator"><img src="img/main/creator_logo.png" alt="Logo Creator"></div>

		<div class="infotext">
			<p>* No black and white photo's. Only color!</p>
			<p>* Photo's with one person only. </p>
			<p>* Professional portretphoto works best. </p>
		</div>

		<div id="loader"></div>
		
		<div class="fileinput"><input class="pictureInput-js" id="inputFileToLoad" type="file" 
			onchange="encodeImageFileAsURL();" /></div>
			<div id="imgPerson"></div>

			<div id="skincolor"></div>

			<div id="haircolor"></div>
			<div id="eyecolor"></div>

			<div class="footer"></div>

			<script type='text/javascript'>

				function encodeImageFileAsURL(callback, context) {

					var filesSelected = document.getElementById("inputFileToLoad").files;
					if (filesSelected.length > 0) {
						var fileToLoad = filesSelected[0];
						var fileReader = new FileReader();
						fileReader.onload = function(fileLoadedEvent) {

			      	// data: base64
			      	var srcData = fileLoadedEvent.target.result; 

			      	var newImage = document.createElement('img');
			      	newImage.src = srcData;

			      	document.getElementById("imgPerson").innerHTML = newImage.outerHTML;

			      	callback && callback.call(context, newImage.src);

			      }

			      fileReader.readAsDataURL(fileToLoad);

			  }
			}

			$('#inputFileToLoad').on('change', function(){
				encodeImageFileAsURL(function(data)
				{
					var base64 = data;
					base64 = base64.replace("data:image/jpeg;base64,", "");

					var msg = '<?xml version="1.0" encoding="utf-8"?><ImageRequestBinary xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">' +
					'<api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
					'<detection_flags>' + "classifiers" + "extended" + '</detection_flags>' +
					'<imagefile_data>' + base64 + '</imagefile_data>' +
					'<original_filename>' + '</original_filename>' +
					'</ImageRequestBinary>';

					$.ajax({
						async: 'true',
						crossDomain: 'true',
						url: 'http://www.betafaceapi.com/service.svc/UploadNewImage_File',
						type: 'POST',
						contentLength: '94998',
						contentType: 'application/xml',
						CacheControl: 'no-cache',
						Pragma: 'no-cache',
						data: msg,
						dataType: 'xml',

						success: function (data, textStatus, jqXHR) {
							var xmlDocRoot = $.parseXML(jqXHR.responseText);
							var xmlDoc = $(xmlDocRoot).children("BetafaceImageResponse");
							var int_response = parseInt($(xmlDoc).children("int_response").text());
							var string_response = $(xmlDoc).children("string_response").text();
							if (int_response == 0) {
								var img_uid = $(xmlDoc).children("img_uid").text();
								getImageInfo(img_uid);
							}
							else {
                            //error
                            console.info(int_response);
                            console.info(string_response);
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                    	console.info(textStatus);
                    } 

                });

				}, this);
			})

			function getImageInfo(imageUid)
			{
				var msg = '<?xml version="1.0" encoding="utf-8"?><ImageInfoRequestUid><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
				'<img_uid>' + imageUid + '</img_uid></ImageInfoRequestUid>';
				//console.log(imageUid);

				$.ajax({
					crossDomain: true,
					url: 'http://www.betafaceapi.com/service.svc/GetImageInfo',
					type: 'post',
					contentType: 'application/xml',
					processData: false,
					data: msg,
					dataType: 'xml',
					success: function (data, textStatus, jqXHR) {
						var xmlDocRoot = $.parseXML(jqXHR.responseText);
						var xmlDoc = $(xmlDocRoot).children("BetafaceImageInfoResponse");
						var int_response = parseInt($(xmlDoc).children("int_response").text());
						var string_response = $(xmlDoc).children("string_response").text();
						var faces = $(xmlDoc).children("faces").text();
						//var uid = $(xmlDoc).children("uid").text();
						var uid = $(xmlDoc).children("faces").children("FaceInfo").children("uid").text();

						if (int_response == 1) {
	                        // image is in the queue
	                        setTimeout(function () { getImageInfo(imageUid); }, 500);
	                        document.getElementById("loader").style.visibility = "visible";
	                        console.log("loading......");
                    	}

						else if (int_response == 0) {
	                        //image processed
	                        document.getElementById("loader").style.visibility = "hidden";
	                        getFaceImage(uid);
                    	}

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                    	console.info(textStatus);
                    } 
                });
            }

            function getFaceImage(uid) 
            {
            	var msg = '<?xml version="1.0" encoding="utf-8"?><FaceRequestId><api_key>d45fd466-51e2-4701-8da8-04351c872236</api_key><api_secret>171e8465-f548-401d-b63b-caf0dc28df5f</api_secret>' +
            	'<face_uid>' + uid + '</face_uid></FaceRequestId>';

            	//console.log(uid);

            	$.ajax({
            		crossDomain: true,
            		url: 'http://www.betafaceapi.com/service.svc/GetFaceImage',
            		type: 'post',
            		contentType: 'application/xml',
            		processData: false,
            		data: msg,
            		dataType: 'xml',
            		success: function (data, textStatus, jqXHR) {
            			var xmlDocRoot = $.parseXML(jqXHR.responseText);
            			var xmlDoc = $(xmlDocRoot).children("BetafaceFaceImageResponse");
            			var int_response = parseInt($(xmlDoc).children("int_response").text());
            			var string_response = $(xmlDoc).children("string_response").text();
            			

            			var TagInfo = parseXml(xmlDoc); //data
            			searchAllPar(TagInfo);
            		},

            		error: function (jqXHR, textStatus, errorThrown) {
            			console.info(textStatus);
            		}
            	});

            	
            };

            function parseXml(xml) {
            	var items = [];
            	$(xml).find("TagInfo").each(function() {
            		items.push({
            			name: $(this).find("name").text(), 
            			value: $(this).find("value").text()
            		});
            	});

            	return items;
            }

             function searchAllPar(TagInfo) {

            	for (var i = 0; i < TagInfo.length; i++) {
            		
            		switch (TagInfo[i].name) {
            			case "age":
            			age = TagInfo[i].value;
            			break;
            			case "gender":
            			gender = TagInfo[i].value;
            			break;
            			case "glasses":
            			glasses = TagInfo[i].value;
            			break;
            			case "race":
            			race = TagInfo[i].value;
            			break;
            			case "color eyes":
            			colorEyes = ("#" + TagInfo[i].value);
            			break;
            			case "color hair":
            			colorHair = ("#" + TagInfo[i].value);
            			break;
            			case "color skin":
            			colorSkin = ("#" + TagInfo[i].value);

            			console.log(age, gender, glasses, race, colorEyes, colorHair, colorSkin);

            		}
            	}

            	$("#eyecolor").css("background-color", colorEyes);
            	$("#haircolor").css("background-color", colorHair);
            	$("#skincolor").css("background-color", colorSkin);
            } 

        </script>
	</section>
</body>
</html>